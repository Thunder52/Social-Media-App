<%- include('partials/navbar.ejs') %>

<body class="bg-light">
  <div class="container mt-4" style="max-width: 600px;">
    <% if(errors && errors.length>0) {%>
      <% errors.forEach(err => { %>
        <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
  <div class="toast-header">
    <strong class="me-auto">Error</strong>
    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
  </div>
  <div class="toast-body">
    <%= err %>
  </div>
</div>
    <%  }); %>
      <% } %>
    <% if(posts && posts.length > 0){ %>
    <% posts.forEach(post => { %>
    <div class="card post-card rounded-4 mb-4">
      <div class="card-header bg-white border-0 d-flex align-items-center justify-content-between p-3">
        <div class="d-flex align-items-center">
          <img src="https://ui-avatars.com/api/?name=<%= encodeURIComponent(post.User ? post.User.fullName : 'U') %>&background=random" alt="avatar" class="rounded-circle avatar-lg me-3">
          <div>
            <h6 class="user-name"><%= post.User ? post.User.fullName : 'Anonymous' %></h6>
            <small class="user-handle">@<%= post.User ? post.User.fullName.toLowerCase().replace(/\s+/g, '') : 'user' %></small>
          </div>
        </div>

        <% if(post.dataValues.isCreater===1){ %>
        <div class="d-flex gap-2">
          <button onclick="window.location.href='/update/<%=post.id%>'" class="btn btn-outline-success action-btn rounded-3">
            <i class="bi bi-pencil-square"></i>
          </button>
          <button onclick="window.location.href='/delete/<%=post.id%>'" class="btn btn-outline-danger action-btn rounded-3">
            <i class="bi bi-trash"></i>
          </button>
        </div>
        <% } %>
      </div>
      <div class="card-body p-0">
        <% if(post.image){ %>
        <img src="<%= post.image %>" class="post-image" alt="Post image">
        <% } %>

        <div class="p-3">
          <p class="post-description mb-0"><%= post.description %></p>
        </div>
      </div>

      <div class="card-footer bg-light border-0 p-3">
        <div class="d-flex gap-3">
          <button class="btn btn-sm interact-btn rounded-3 d-flex align-items-center gap-2" onclick="toggleComments(<%=post.id%>)">
            <i class="bi bi-chat"></i>
            <span><%= post.Comments ? post.Comments.length : 0 %></span>
          </button>
        </div>
      </div>
      <div id="comments-<%= post.id %>" class="p-3 bg-light border-top" style="display: none;">
        <form action="/comment" method="post" class="mb-3">
          <input type="hidden" name="postId" value="<%= post.id %>">
          <div class="input-group">
            <input type="text" name="comment" class="form-control comment-input" placeholder="Write a comment..." required>
            <button type="submit" class="btn btn-primary comment-submit ms-2">Post</button>
          </div>
        </form>

        <% if(post.Comments && post.Comments.length > 0){ %>
        <div class="comment-list">
          <% post.Comments.forEach(comment => { %>
          <div class="d-flex justify-between gap-2 mb-3">
            <img src="https://ui-avatars.com/api/?name=<%= encodeURIComponent(comment.User ? comment.User.fullName : 'U') %>&background=random" alt="avatar" class="rounded-circle avatar-sm">
            <div class="comment-content p-3 flex-grow-1">
              <div class="comment-author mb-1">
                <%= comment.User ? comment.User.fullName : 'Anonymous' %>
              </div>
              <div class="comment-text">
              <%= comment.comment %>
            <div class="d-flex gap-2 justify-content-end">
          <button onclick="handleUpdate(<%= comment.id %> , '<%= post.id %>')" class="btn btn-outline-success action-btn rounded-3">
            <i class="bi bi-pencil-square"></i>
          </button>
          <button onclick="window.location.href='/delete-comment/<%=comment.id%>'" class="btn btn-outline-danger action-btn rounded-3">
            <i class="bi bi-trash"></i>
          </button>
        </div>
              </div>
            </div>
          </div>
          <% }) %>
        </div>
        <% } else { %>
        <div class="text-center text-muted py-3">
          <i class="bi bi-chat-dots fs-2 d-block mb-2"></i>
          <small>No comments yet. Be the first to comment!</small>
        </div>
        <% } %>
      </div>
    </div>
    <% }) %>
    <nav aria-label="Page navigation" class="d-flex justify-content-center mb-5">
      <ul class="pagination">
        <li class="page-item <%= currPage == 1 ? 'disabled' : '' %>">
          <a class="page-link" href="/home?page=<%= currPage - 1 %>" tabindex="-1">
            <i class="bi bi-chevron-left"></i> Previous
          </a>
        </li>
        <% for(let i = 1; i <= totalPage; i++){ %>
        <li class="page-item <%= currPage == i ? 'active' : '' %>">
          <a class="page-link" href="/home?page=<%= i %>"><%= i %></a>
        </li>
        <% } %>
        <li class="page-item <%= currPage == totalPage ? 'disabled' : '' %>">
          <a class="page-link" href="/home?page=<%= currPage + 1 %>">
            Next <i class="bi bi-chevron-right"></i>
          </a>
        </li>
      </ul>
    </nav>

    <% } else { %>
    <div class="text-center py-5">
      <i class="bi bi-inbox text-muted" style="font-size: 64px;"></i>
      <h2 class="text-secondary mt-3">No Posts Available</h2>
      <p class="text-muted">Be the first to share something!</p>
    </div>
    <% } %>
  </div>

  <script>
    function toggleComments(id) {
      const commentsDiv = document.getElementById(`comments-${id}`);
      commentsDiv.style.display = (commentsDiv.style.display === "none" || commentsDiv.style.display === "") ?
        "block" :
        "none";
    }
    const commentContainer = document.querySelector('.comment-content');
    function handleUpdate(commentId,postId){
      commentContainer.innerHTML=`<form action="/update-comment/${commentId}" method="POST" class="d-flex gap-2">
        <input type="hidden" name="postId" value="${postId}">
        <input type="text" name="comment" class="form-control" placeholder="Edit your comment..." required>
        <button type="submit" class="btn btn-primary">Update</button>
      </form>`;
    }

  </script>
</body>

</html>